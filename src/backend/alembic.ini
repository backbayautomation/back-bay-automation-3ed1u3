# Enhanced Alembic configuration file for AI-powered Product Catalog Search System
# Version: 1.0.0

[alembic]
# Path to migration scripts directory
script_location = migrations

# Template used to generate migration files with timestamp and description
file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# Set timezone to UTC for consistent timestamps
timezone = UTC

# Maximum length of migration description
truncate_slug_length = 40

# Enable access to revision environment
revision_environment = true

# Disable sourceless evaluation for security
sourceless = false

# Multi-tenant version locations
version_locations = %(here)s/versions/%(tenant)s

# Version path separator - use OS default
version_path_separator = os

# SQLAlchemy database URL with environment variables
sqlalchemy.url = postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}

# Enhanced database connection settings
ssl_mode = verify-full
connect_timeout = 10
pool_size = 5
max_overflow = 10
pool_timeout = 30
pool_recycle = 1800

[loggers]
keys = root,sqlalchemy,alembic,tenant

[logger_root]
level = INFO
handlers = console,file,json
qualname = 
formatter = json

[logger_sqlalchemy]
level = INFO
handlers = console,file,json
qualname = sqlalchemy.engine
formatter = json
tenant_context = true

[logger_alembic]
level = INFO
handlers = console,file,json
qualname = alembic
formatter = json
performance_metrics = true

[logger_tenant]
level = INFO
handlers = console,file,json
qualname = alembic.tenant
formatter = json
audit_logging = true

[handlers]
keys = console,file,json

[handler_console]
class = logging.StreamHandler
level = INFO
formatter = json
args = (sys.stderr,)

[handler_file]
class = logging.handlers.RotatingFileHandler
level = DEBUG
formatter = json
args = ('/var/log/alembic/migrations.log', 'a', 10485760, 5)

[handler_json]
class = pythonjsonlogger.jsonlogger.JsonFormatter
level = INFO
formatter = json
args = ('/var/log/alembic/migrations.json', 'a', 10485760, 5)

[formatters]
keys = generic,json

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %Y-%m-%d %H:%M:%S

[formatter_json]
format = %(asctime)s %(levelname)s %(name)s %(tenant)s %(message)s
datefmt = %Y-%m-%d %H:%M:%S
class = pythonjsonlogger.jsonlogger.JsonFormatter
include_tenant = true
include_trace_id = true

# Alembic offline generation settings
[alembic:offline]
sqlalchemy.url = driver://

# Alembic branch labels
[alembic:branch_labels]
tenant = true

# Alembic custom environment settings
[alembic:env]
transaction_per_migration = true
atomic_migrations = true
transactional_ddl = true
compare_type = true
compare_server_default = true
include_schemas = true
include_name = true
include_object = true